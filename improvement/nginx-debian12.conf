# =====================================================
# FOS-Streaming Nginx Configuration
# Optimized for Debian 12 with Enhanced Security
# Nginx 1.26+ with RTMP, HTTP/2, security headers
# Date: 2025-11-21
# =====================================================

user nginx;
worker_processes auto;
worker_rlimit_nofile 655350;

# Error log
error_log /home/fos-streaming/fos/logs/error.log warn;
pid /home/fos-streaming/fos/nginx/pid/nginx.pid;

events {
    worker_connections 65535;
    use epoll;
    accept_mutex on;
    multi_accept on;
}

http {
    # ===============================================
    # Basic Settings
    # ===============================================
    include                   mime.types;
    default_type              application/octet-stream;

    # Hide nginx version
    server_tokens             off;
    more_clear_headers        'Server';
    more_clear_headers        'X-Powered-By';

    # ===============================================
    # Performance Tuning
    # ===============================================
    sendfile                  on;
    tcp_nopush                on;
    tcp_nodelay               on;
    reset_timedout_connection on;
    keepalive_timeout         10;
    client_max_body_size      999m;
    client_body_buffer_size   128k;
    send_timeout              120s;
    sendfile_max_chunk        512k;
    lingering_close           off;

    # FastCGI settings
    fastcgi_read_timeout      200;
    fastcgi_send_timeout      180;
    fastcgi_connect_timeout   180;

    # ===============================================
    # Buffer Settings
    # ===============================================
    client_header_buffer_size    1k;
    large_client_header_buffers  4 8k;
    client_body_timeout          60;
    client_header_timeout        60;

    # ===============================================
    # Compression (disabled for streaming)
    # ===============================================
    gzip                      off;

    # ===============================================
    # Logging
    # ===============================================
    access_log                off;

    # Custom log format for security monitoring
    log_format security '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       '$request_time $upstream_response_time';

    # ===============================================
    # Rate Limiting Zones
    # ===============================================
    # Login rate limiting (5 requests per minute per IP)
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

    # Streaming rate limiting (10 requests per second per IP)
    limit_req_zone $binary_remote_addr zone=streaming_limit:10m rate=10r/s;

    # General API rate limiting (20 requests per second per IP)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;

    # Connection limiting (max 5 concurrent connections per IP for streams)
    limit_conn_zone $binary_remote_addr zone=concurrent_streams:10m;

    # ===============================================
    # Security Headers (applied globally)
    # ===============================================
    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Enable XSS protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self'; media-src 'self' blob:;" always;

    # Permissions Policy (formerly Feature-Policy)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ===============================================
    # Map for blocking bad user agents
    # ===============================================
    map $http_user_agent $bad_bot {
        default 0;
        ~*^$ 1;  # Empty user agent
        ~*(bot|crawler|spider|scraper) 1;
    }

    # ===============================================
    # STREAMING SERVER (Port 8000)
    # ===============================================
    server {
        listen 8000;
        listen [::]:8000;

        server_name _;
        root /home/fos-streaming/fos/www1/;

        # Security
        server_tokens off;
        chunked_transfer_encoding off;

        # Access log for streaming (useful for analytics)
        access_log /home/fos-streaming/fos/logs/streaming-access.log security;

        # Rate limiting
        limit_req zone=streaming_limit burst=20 nodelay;
        limit_conn concurrent_streams 5;

        # Block bad bots
        if ($bad_bot) {
            return 403;
        }

        # Stream URL rewrite
        # Format: /live/{username}/{password}/{stream}
        rewrite ^/live/(.*)/(.*)/(.*)$ /stream.php?username=$1&password=$2&stream=$3 break;

        # Security: Block access to sensitive files
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        location ~ /\.git {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to composer, configs, etc
        location ~ /(composer\.(json|lock)|package\.json|\.env|config\.php)$ {
            deny all;
        }

        # HLS streaming (.m3u8, .ts files)
        location ~ \.(m3u8|ts)$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            add_header Access-Control-Allow-Origin "*";
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
        }

        # PHP processing
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_index index.php;
            include fastcgi_params;

            # FastCGI tuning
            fastcgi_buffering on;
            fastcgi_buffers 96 32k;
            fastcgi_buffer_size 32k;
            fastcgi_max_temp_file_size 0;
            fastcgi_keep_conn on;

            fastcgi_param SCRIPT_FILENAME /home/fos-streaming/fos/www1/$fastcgi_script_name;
            fastcgi_param SCRIPT_NAME $fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_pass 127.0.0.1:9002;

            # Security headers for PHP responses
            fastcgi_hide_header X-Powered-By;
        }

        # Deny access to all other file types except media
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 1h;
            add_header Cache-Control "public, immutable";
        }
    }

    # ===============================================
    # WEB PANEL SERVER (Port 7777)
    # ===============================================
    server {
        listen 7777;
        listen [::]:7777;

        server_name _;
        root /home/fos-streaming/fos/www/;
        index index.php index.html index.htm;

        # Security
        server_tokens off;
        chunked_transfer_encoding off;

        # Access log for web panel
        access_log /home/fos-streaming/fos/logs/panel-access.log security;

        # Rate limiting for general API
        limit_req zone=api_limit burst=30 nodelay;

        # Security: Block access to sensitive files and directories
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        location ~ /\.git {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Block access to composer, vendor, configs
        location ~ /(composer\.(json|lock)|package\.json|\.env)$ {
            deny all;
        }

        location ^~ /vendor/ {
            deny all;
        }

        location ^~ /.git/ {
            deny all;
        }

        # Login page - strict rate limiting
        location = /index.php {
            limit_req zone=login_limit burst=3 nodelay;

            try_files $uri =404;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_buffering on;
            fastcgi_buffers 96 32k;
            fastcgi_buffer_size 32k;
            fastcgi_max_temp_file_size 0;
            fastcgi_keep_conn on;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param SCRIPT_NAME $fastcgi_script_name;
            fastcgi_pass 127.0.0.1:9002;

            # Additional security for login
            fastcgi_hide_header X-Powered-By;
        }

        # HLS directory
        location /hl/ {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            add_header Cache-Control "no-cache";
            add_header Access-Control-Allow-Origin "*";
        }

        # Static files
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # PHP processing
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_index index.php;
            include fastcgi_params;

            # FastCGI tuning
            fastcgi_buffering on;
            fastcgi_buffers 96 32k;
            fastcgi_buffer_size 32k;
            fastcgi_max_temp_file_size 0;
            fastcgi_keep_conn on;

            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param SCRIPT_NAME $fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_pass 127.0.0.1:9002;

            # Security headers
            fastcgi_hide_header X-Powered-By;
        }

        # Default location
        location / {
            try_files $uri $uri/ =404;
        }

        # Block execution of scripts in upload directories
        location /uploads/ {
            location ~ \.php$ {
                deny all;
            }
        }

        # Health check endpoint (optional)
        location = /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}

# ===============================================
# RTMP Server Configuration
# ===============================================
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        # RTMP application for live streaming
        application live {
            live on;
            record off;

            # HLS settings
            hls on;
            hls_path /home/fos-streaming/fos/www/hl;
            hls_fragment 3s;
            hls_playlist_length 20s;
            hls_cleanup on;
            hls_nested on;

            # Authentication
            # on_publish http://127.0.0.1:7777/rtmp_auth.php;
            # on_play http://127.0.0.1:7777/rtmp_auth.php;

            # Notifications
            # on_publish_done http://127.0.0.1:7777/rtmp_done.php;

            # Allow publishing from localhost
            allow publish 127.0.0.1;
            allow publish all;

            # Allow play from anywhere
            allow play all;
        }
    }
}
