#!/bin/bash
################################################################################
# FOS-Streaming v69 Installation Script for Debian 12 (Bookworm)
#
# Features:
#   - PHP 8.4 with all modern extensions
#   - MariaDB 11.x (latest stable)
#   - Nginx 1.26.x with RTMP, HTTP/2, HTTP/3 support
#   - FFmpeg latest static build
#   - Enhanced security configurations
#   - Automated setup and deployment
#
# Date: 2025-11-21
# Supported OS: Debian 12 (Bookworm) only
################################################################################

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
PHP_VERSION="8.4"
MARIADB_VERSION="11.4"
FOS_USER="fosstreaming"
FOS_HOME="/home/fos-streaming"
FOS_DIR="${FOS_HOME}/fos"
PORTS_CONFIG="${FOS_DIR}/www/config/ports.php"
CERTS_DIR="${FOS_DIR}/nginx/conf/certs"

# Ports will be randomly selected during installation
# Web/Stream ports: Cloudflare SSL-compatible
# RTMP port: Random unused port
WEB_PORT=""
STREAM_PORT=""
RTMP_PORT=""

# Logging functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "\n${BLUE}===${NC} $1 ${BLUE}===${NC}\n"
}

# Error handler
error_exit() {
    log_error "$1"
    exit 1
}

# ============================================================================
# Port Selection Functions
# ============================================================================

# Check if a port is available
is_port_available() {
    local port=$1
    if lsof -i :${port} -sTCP:LISTEN -t >/dev/null 2>&1 ; then
        return 1  # Port is in use
    fi
    if netstat -tuln 2>/dev/null | grep -q ":${port} " ; then
        return 1  # Port is in use
    fi
    return 0  # Port is available
}

# Get random available Cloudflare SSL-compatible port
get_random_ssl_port() {
    # Cloudflare-supported HTTPS ports
    local cloudflare_ports=(2053 2083 2087 2096 8443)
    local exclude_ports=("$@")

    # Shuffle array using shuf if available, otherwise use bash
    if command -v shuf &> /dev/null; then
        cloudflare_ports=($(printf '%s\n' "${cloudflare_ports[@]}" | shuf))
    else
        # Fallback: simple randomization
        local n=${#cloudflare_ports[@]}
        for ((i = n - 1; i > 0; i--)); do
            local j=$((RANDOM % (i + 1)))
            local tmp=${cloudflare_ports[i]}
            cloudflare_ports[i]=${cloudflare_ports[j]}
            cloudflare_ports[j]=$tmp
        done
    fi

    # Find first available port
    for port in "${cloudflare_ports[@]}"; do
        local excluded=0
        for exclude_port in "${exclude_ports[@]}"; do
            if [ "$port" == "$exclude_port" ]; then
                excluded=1
                break
            fi
        done

        if [ $excluded -eq 0 ] && is_port_available $port; then
            echo $port
            return 0
        fi
    done

    # If no Cloudflare port available, try extended range
    log_warn "No Cloudflare SSL port available, trying extended range..."
    for port in $(seq 8000 8999 | sort -R | head -20); do
        local excluded=0
        for exclude_port in "${exclude_ports[@]}"; do
            if [ "$port" == "$exclude_port" ]; then
                excluded=1
                break
            fi
        done

        if [ $excluded -eq 0 ] && is_port_available $port; then
            echo $port
            return 0
        fi
    done

    return 1  # No port available
}

# Get random available port for RTMP (from standard streaming port range)
get_random_rtmp_port() {
    local exclude_ports=("$@")

    # RTMP typically uses 1935, but we want random ports
    # Use common streaming port ranges: 1935-1999, 8000-8999
    local port_ranges=(
        $(seq 1935 1999 | sort -R | head -10)
        $(seq 8000 8999 | sort -R | head -20)
    )

    # Shuffle the combined array
    if command -v shuf &> /dev/null; then
        port_ranges=($(printf '%s\n' "${port_ranges[@]}" | shuf))
    fi

    # Find first available port
    for port in "${port_ranges[@]}"; do
        local excluded=0
        for exclude_port in "${exclude_ports[@]}"; do
            if [ "$port" == "$exclude_port" ]; then
                excluded=1
                break
            fi
        done

        if [ $excluded -eq 0 ] && is_port_available $port; then
            echo $port
            return 0
        fi
    done

    return 1  # No port available
}

# Select random ports for installation
select_random_ports() {
    log_info "Selecting random ports for installation..."

    # Select web port (Cloudflare SSL-compatible)
    WEB_PORT=$(get_random_ssl_port)
    if [ -z "$WEB_PORT" ]; then
        error_exit "Unable to find available port for web service"
    fi
    log_info "Selected web port: ${WEB_PORT} (HTTPS)"

    # Select stream port (Cloudflare SSL-compatible, different from web)
    STREAM_PORT=$(get_random_ssl_port "$WEB_PORT")
    if [ -z "$STREAM_PORT" ]; then
        error_exit "Unable to find available port for streaming service"
    fi
    log_info "Selected stream port: ${STREAM_PORT} (HTTPS)"

    # Select RTMP port (random unused port, different from web and stream)
    RTMP_PORT=$(get_random_rtmp_port "$WEB_PORT" "$STREAM_PORT")
    if [ -z "$RTMP_PORT" ]; then
        error_exit "Unable to find available port for RTMP service"
    fi
    log_info "Selected RTMP port: ${RTMP_PORT}"

    # Verify web and stream ports are Cloudflare-compatible
    local cf_ports=(2053 2083 2087 2096 8443)
    local web_is_cf=0
    local stream_is_cf=0

    for p in "${cf_ports[@]}"; do
        [ "$WEB_PORT" == "$p" ] && web_is_cf=1
        [ "$STREAM_PORT" == "$p" ] && stream_is_cf=1
    done

    if [ $web_is_cf -eq 1 ] && [ $stream_is_cf -eq 1 ]; then
        log_info "Web and Stream ports are Cloudflare SSL-compatible âœ“"
    else
        log_warn "One or more HTTPS ports may not work with Cloudflare SSL proxy"
    fi

    log_info "All ports verified as available and unique"
}

# ============================================================================
# SSL Certificate Functions
# ============================================================================

# Generate self-signed SSL certificate
generate_self_signed_cert() {
    local domain=$1
    local cert_dir=$2

    log_info "Generating self-signed SSL certificate..."

    mkdir -p "$cert_dir"

    # Generate private key and certificate
    openssl req -x509 -nodes -days 365 -newkey rsa:4096 \
        -keyout "${cert_dir}/privkey.pem" \
        -out "${cert_dir}/fullchain.pem" \
        -subj "/C=US/ST=State/L=City/O=FOS-Streaming/CN=${domain}" \
        2>/dev/null

    if [ $? -eq 0 ]; then
        log_info "Self-signed certificate generated successfully"
        chmod 600 "${cert_dir}/privkey.pem"
        chmod 644 "${cert_dir}/fullchain.pem"
        return 0
    else
        log_error "Failed to generate self-signed certificate"
        return 1
    fi
}

# Upgrade to Let's Encrypt certificate
upgrade_to_letsencrypt() {
    local domain=$1
    local email=$2
    local cert_dir=$3

    log_info "Upgrading to Let's Encrypt certificate..."

    # Install certbot if not present
    if ! command -v certbot &> /dev/null; then
        log_info "Installing certbot..."
        apt-get install -y certbot
    fi

    # Stop nginx temporarily
    systemctl stop fos-nginx

    # Obtain certificate using standalone mode
    certbot certonly --standalone --non-interactive --agree-tos \
        --email "$email" -d "$domain" \
        --cert-path "${cert_dir}/fullchain.pem" \
        --key-path "${cert_dir}/privkey.pem"

    if [ $? -eq 0 ]; then
        log_info "Let's Encrypt certificate obtained successfully"

        # Create renewal hook
        cat > /etc/letsencrypt/renewal-hooks/deploy/fos-nginx-reload.sh <<'EOF'
#!/bin/bash
systemctl reload fos-nginx
EOF
        chmod +x /etc/letsencrypt/renewal-hooks/deploy/fos-nginx-reload.sh

        systemctl start fos-nginx
        return 0
    else
        log_error "Failed to obtain Let's Encrypt certificate"
        log_info "Continuing with self-signed certificate"
        systemctl start fos-nginx
        return 1
    fi
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    error_exit "This script must be run as root"
fi

# Check if Debian 12
if [ ! -f /etc/debian_version ]; then
    error_exit "This script is for Debian only"
fi

DEBIAN_VERSION=$(cat /etc/debian_version | cut -d. -f1)
if [ "$DEBIAN_VERSION" != "12" ]; then
    log_warn "This script is designed for Debian 12. Current version: $DEBIAN_VERSION"
    read -p "Do you want to continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

log_step "FOS-Streaming v69 Installation for Debian 12"
log_info "PHP Version: ${PHP_VERSION}"
log_info "MariaDB Version: ${MARIADB_VERSION}"
log_info "Installation Directory: ${FOS_DIR}"

# ============================================================================
# STEP 0: Port Selection
# ============================================================================
log_step "Step 0: Port Selection and Security Setup"

select_random_ports

log_info "Installation will use:"
log_info "  Web Port: ${WEB_PORT} (HTTPS)"
log_info "  Stream Port: ${STREAM_PORT} (HTTPS)"
log_info "  RTMP Port: ${RTMP_PORT}"

# Get server IP for certificate
PUBLIC_IP=$(curl -s https://api.ipify.org 2>/dev/null || hostname -I | awk '{print $1}')
log_info "Server IP: ${PUBLIC_IP}"

# ============================================================================
# STEP 1: System Update
# ============================================================================
log_step "Step 1: Updating System"

apt-get update -y
apt-get upgrade -y
apt-get dist-upgrade -y
apt-get autoremove -y

# ============================================================================
# STEP 2: Install Build Dependencies
# ============================================================================
log_step "Step 2: Installing Build Dependencies"

apt-get install -y \
    build-essential \
    libssl-dev \
    libpcre3 \
    libpcre3-dev \
    zlib1g-dev \
    curl \
    nano \
    wget \
    zip \
    unzip \
    git \
    lsof \
    iftop \
    htop \
    vim \
    ca-certificates \
    apt-transport-https \
    gnupg2 \
    software-properties-common \
    dirmngr

# ============================================================================
# STEP 3: Install Library Dependencies
# ============================================================================
log_step "Step 3: Installing Library Dependencies"

apt-get install -y \
    libxml2-dev \
    libbz2-dev \
    libcurl4-openssl-dev \
    libxslt1-dev \
    libpq-dev \
    libsqlite3-dev \
    libgd-dev \
    libgeoip-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    libwebp-dev \
    libxpm-dev \
    libtidy-dev \
    libzip-dev \
    libonig-dev \
    libreadline-dev \
    libedit-dev \
    libsodium-dev

apt-get autoremove -y

# ============================================================================
# STEP 4: Setup PHP 8.4 from Sury Repository
# ============================================================================
log_step "Step 4: Setting up PHP ${PHP_VERSION}"

# Add Sury PHP repository for Debian 12
log_info "Adding Sury PHP repository..."
curl -sSL https://packages.sury.org/php/apt.gpg -o /etc/apt/trusted.gpg.d/php-sury.gpg
echo "deb https://packages.sury.org/php/ bookworm main" > /etc/apt/sources.list.d/php-sury.list

apt-get update -y

# Install PHP 8.4 and extensions
log_info "Installing PHP ${PHP_VERSION} and extensions..."
apt-get install -y \
    php${PHP_VERSION} \
    php${PHP_VERSION}-cli \
    php${PHP_VERSION}-fpm \
    php${PHP_VERSION}-common \
    php${PHP_VERSION}-mysql \
    php${PHP_VERSION}-curl \
    php${PHP_VERSION}-gd \
    php${PHP_VERSION}-mbstring \
    php${PHP_VERSION}-xml \
    php${PHP_VERSION}-zip \
    php${PHP_VERSION}-bcmath \
    php${PHP_VERSION}-intl \
    php${PHP_VERSION}-opcache \
    php${PHP_VERSION}-readline \
    php${PHP_VERSION}-bz2 \
    php${PHP_VERSION}-soap \
    php${PHP_VERSION}-xsl

# ============================================================================
# STEP 5: Configure PHP 8.4
# ============================================================================
log_step "Step 5: Configuring PHP ${PHP_VERSION}"

# Download optimized PHP-FPM pool configuration
log_info "Downloading PHP-FPM pool configuration..."
curl -s https://raw.githubusercontent.com/theraw/FOS-Streaming-v69/master/improvement/php84.conf > /etc/php/${PHP_VERSION}/fpm/pool.d/www.conf 2>/dev/null || {
    log_warn "Could not download php84.conf, using local version..."
    cat > /etc/php/${PHP_VERSION}/fpm/pool.d/www.conf <<'EOF'
[php84]
user = nginx
group = nginx
listen = 127.0.0.1:9002
listen.owner = nginx
listen.group = nginx
pm = ondemand
pm.max_children = 300
pm.start_servers = 10
pm.min_spare_servers = 10
pm.max_spare_servers = 100
pm.process_idle_timeout = 3s
pm.max_requests = 500
security.limit_extensions = .php
php_admin_value[error_log] = /home/fos-streaming/fos/logs/php-fpm.log
php_admin_flag[log_errors] = on
php_admin_value[memory_limit] = 1128M
php_admin_value[upload_max_filesize] = 10M
php_admin_value[post_max_size] = 10M
php_admin_value[max_execution_time] = 300
php_admin_value[max_input_time] = 300

; Session security
php_admin_value[session.cookie_httponly] = 1
php_admin_value[session.cookie_samesite] = "Strict"
php_admin_value[session.use_strict_mode] = 1
php_admin_value[session.use_only_cookies] = 1
php_admin_value[session.cookie_secure] = 0

; Security settings
php_admin_value[expose_php] = Off
php_admin_value[display_errors] = Off
php_admin_value[log_errors] = On
php_admin_value[error_reporting] = E_ALL
EOF
}

# Configure php.ini for security and performance
log_info "Configuring php.ini..."
PHP_INI="/etc/php/${PHP_VERSION}/fpm/php.ini"

# Security settings
sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g' "$PHP_INI"
sed -i 's/output_buffering = 4096/output_buffering = Off/g' "$PHP_INI"
sed -i 's/expose_php = On/expose_php = Off/g' "$PHP_INI"
sed -i 's/;date.timezone =/date.timezone = UTC/g' "$PHP_INI"
sed -i 's/display_errors = On/display_errors = Off/g' "$PHP_INI"
sed -i 's/error_reporting = .*/error_reporting = E_ALL/g' "$PHP_INI"

# Enable opcache for performance
sed -i 's/;opcache.enable=1/opcache.enable=1/g' "$PHP_INI"
sed -i 's/;opcache.memory_consumption=128/opcache.memory_consumption=256/g' "$PHP_INI"
sed -i 's/;opcache.interned_strings_buffer=8/opcache.interned_strings_buffer=16/g' "$PHP_INI"
sed -i 's/;opcache.max_accelerated_files=10000/opcache.max_accelerated_files=20000/g' "$PHP_INI"
sed -i 's/;opcache.validate_timestamps=1/opcache.validate_timestamps=0/g' "$PHP_INI"

# ============================================================================
# STEP 6: Create System User
# ============================================================================
log_step "Step 6: Creating System User"

# Create nginx user for PHP-FPM
if ! id "nginx" &>/dev/null; then
    useradd -r -s /sbin/nologin nginx
    log_info "Created nginx user"
fi

# Create FOS user
if ! id "$FOS_USER" &>/dev/null; then
    useradd -s /sbin/nologin -U -d "$FOS_HOME" -m "$FOS_USER"
    log_info "Created $FOS_USER user"
fi

# Restart PHP-FPM
systemctl restart php${PHP_VERSION}-fpm
systemctl enable php${PHP_VERSION}-fpm

# ============================================================================
# STEP 7: Install MariaDB
# ============================================================================
log_step "Step 7: Installing MariaDB ${MARIADB_VERSION}"

# Add MariaDB repository
log_info "Adding MariaDB repository..."
curl -o /etc/apt/trusted.gpg.d/mariadb_release_signing_key.asc 'https://mariadb.org/mariadb_release_signing_key.asc'
echo "deb [arch=amd64,arm64] https://mirrors.xtom.com/mariadb/repo/${MARIADB_VERSION}/debian bookworm main" > /etc/apt/sources.list.d/mariadb.list

apt-get update -y
apt-get install -y mariadb-server mariadb-client

# Generate strong MySQL root password
log_info "Generating MySQL root password..."
SQL_PASSWD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)
echo "$SQL_PASSWD" > /root/MYSQL_ROOT_PASSWORD
chmod 600 /root/MYSQL_ROOT_PASSWORD

# Secure MariaDB installation
log_info "Configuring MariaDB..."
systemctl stop mariadb
systemctl start mariadb

# Set root password and secure installation
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '${SQL_PASSWD}';"
mysql -u root -p"${SQL_PASSWD}" -e "DELETE FROM mysql.user WHERE User='';"
mysql -u root -p"${SQL_PASSWD}" -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
mysql -u root -p"${SQL_PASSWD}" -e "DROP DATABASE IF EXISTS test;"
mysql -u root -p"${SQL_PASSWD}" -e "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';"
mysql -u root -p"${SQL_PASSWD}" -e "FLUSH PRIVILEGES;"

# Create FOS database
log_info "Creating FOS database..."
mysql -u root -p"${SQL_PASSWD}" -e "CREATE DATABASE IF NOT EXISTS fos CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -u root -p"${SQL_PASSWD}" -e "GRANT ALL PRIVILEGES ON fos.* TO 'fos'@'localhost' IDENTIFIED BY '${SQL_PASSWD}';"
mysql -u root -p"${SQL_PASSWD}" -e "FLUSH PRIVILEGES;"

# Configure MariaDB for performance
log_info "Optimizing MariaDB configuration..."
cat >> /etc/mysql/mariadb.conf.d/99-fos.cnf <<'EOF'
[mysqld]
# FOS-Streaming optimizations
max_connections = 500
innodb_buffer_pool_size = 512M
innodb_log_file_size = 128M
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1
query_cache_type = 0
query_cache_size = 0

# Security
local_infile = 0
bind-address = 127.0.0.1

# Performance
max_allowed_packet = 64M
tmp_table_size = 64M
max_heap_table_size = 64M
EOF

systemctl restart mariadb
systemctl enable mariadb

# ============================================================================
# STEP 8: Clone and Build Nginx
# ============================================================================
log_step "Step 8: Building Nginx with RTMP Module"

# Clone fospackv69 repository
log_info "Cloning fospackv69 repository..."
cd /
rm -rf /fospackv69
git clone --recurse-submodules https://github.com/theraw/fospackv69.git

# Copy fos directory structure
log_info "Setting up FOS directory structure..."
cp -a /fospackv69/fos "$FOS_HOME/"

# Build nginx
log_info "Building nginx (this will take several minutes)..."
cd /fospackv69/nginx-builder

# Update build script to download latest nginx if needed
if [ ! -f "build-debian12.sh" ]; then
    log_warn "Using original build script..."
    bash build.sh
else
    log_info "Using Debian 12 optimized build script..."
    bash build-debian12.sh
fi

# Cleanup
cd /
rm -rf /fospackv69

# ============================================================================
# STEP 9: Clone FOS-Streaming Web Application
# ============================================================================
log_step "Step 9: Installing FOS-Streaming Web Application"

# Clean up existing files
rm -rf "${FOS_DIR}/www/vendor" "${FOS_DIR}/www/50x.html"

# Clone repository
log_info "Cloning FOS-Streaming repository..."
cd "${FOS_DIR}/www"
git clone https://github.com/theraw/FOS-Streaming-v69.git

# Copy files to www directory
cp -R "${FOS_DIR}/www/FOS-Streaming-v69/"* "${FOS_DIR}/www/"
rm -rf "${FOS_DIR}/www/FOS-Streaming-v69/"

# ============================================================================
# STEP 10: Configure Application
# ============================================================================
log_step "Step 10: Configuring FOS-Streaming Application"

# Update database configuration
log_info "Updating database configuration..."
sed -i "s/'xxx'/'fos'/g" "${FOS_DIR}/www/config.php"
sed -i "s/'zzz'/'${SQL_PASSWD}'/g" "${FOS_DIR}/www/config.php"
sed -i "s/'ttt'/'fos'/g" "${FOS_DIR}/www/config.php"

# Create required directories
log_info "Creating application directories..."
mkdir -p "${FOS_DIR}/www/config"
mkdir -p "${FOS_DIR}/www/lib"
mkdir -p "${FOS_DIR}/www/hl"
chmod 777 "${FOS_DIR}/www/hl"
mkdir -p "${FOS_DIR}/www/cache"
chmod 777 "${FOS_DIR}/www/cache"
mkdir -p "${FOS_DIR}/www1/log"
mkdir -p "${FOS_DIR}/logs"

# Save port configuration
log_info "Saving port configuration..."
cat > "${FOS_DIR}/www/config/ports.php" <<EOF
<?php
/**
 * FOS-Streaming Port Configuration
 *
 * This file is auto-generated during installation and contains
 * the randomly selected ports for web and streaming services.
 *
 * DO NOT EDIT MANUALLY - This file is managed by the installer
 * Generated: $(date '+%Y-%m-%d %H:%M:%S')
 */

return [
    'web_port' => ${WEB_PORT},      // Web panel HTTPS port
    'stream_port' => ${STREAM_PORT},   // Streaming HTTPS port
    'rtmp_port' => ${RTMP_PORT},     // RTMP port (random)
];
EOF

chmod 644 "${FOS_DIR}/www/config/ports.php"

# Setup www1 directory for streaming
log_info "Setting up streaming directory..."
cp -R "${FOS_DIR}/www/"* "${FOS_DIR}/www1/"
rm -rf "${FOS_DIR}/www1/"*.* "${FOS_DIR}/www1/hl"

# Create symbolic links
ln -sf "${FOS_DIR}/www/hl" "${FOS_DIR}/www1/hl"
ln -sf "${FOS_DIR}/www/config.php" "${FOS_DIR}/www1/config.php"
ln -sf "${FOS_DIR}/www/functions.php" "${FOS_DIR}/www1/functions.php"
ln -sf "${FOS_DIR}/www/stream.php" "${FOS_DIR}/www1/stream.php"
ln -sf "${FOS_DIR}/www/playlist.php" "${FOS_DIR}/www1/playlist.php"

# Create PHP symlink
ln -sf /usr/bin/php "${FOS_DIR}/php/bin/php"

# Set permissions
log_info "Setting permissions..."
chown -R nginx:nginx "${FOS_DIR}/www"
chown -R nginx:nginx "${FOS_DIR}/www1"
chown -R fosstreaming:fosstreaming "${FOS_DIR}/nginx"
chown -R nginx:nginx "${FOS_DIR}/logs"

# ============================================================================
# STEP 11: Install FFmpeg
# ============================================================================
log_step "Step 11: Installing FFmpeg"

log_info "Downloading latest FFmpeg static build..."
wget -q "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz" -O /tmp/ffmpeg-release-amd64-static.tar.xz

log_info "Extracting FFmpeg..."
tar -xJf /tmp/ffmpeg-release-amd64-static.tar.xz -C /tmp/

log_info "Installing FFmpeg binaries..."
cp /tmp/ffmpeg-*/ffmpeg /usr/local/bin/ffmpeg
cp /tmp/ffmpeg-*/ffprobe /usr/local/bin/ffprobe
chmod 755 /usr/local/bin/ffmpeg
chmod 755 /usr/local/bin/ffprobe

# Cleanup
rm -rf /tmp/ffmpeg-*

# Add to sudoers for nginx user
log_info "Configuring FFmpeg sudo access..."
echo 'nginx ALL = (root) NOPASSWD: /usr/local/bin/ffmpeg' >> /etc/sudoers
echo 'nginx ALL = (root) NOPASSWD: /usr/local/bin/ffprobe' >> /etc/sudoers

# ============================================================================
# STEP 12: Configure Nginx and SSL Certificates
# ============================================================================
log_step "Step 12: Configuring Nginx and SSL Certificates"

# Generate self-signed SSL certificate
generate_self_signed_cert "${PUBLIC_IP}" "${CERTS_DIR}"

log_info "Downloading nginx configuration..."
curl -s https://raw.githubusercontent.com/theraw/FOS-Streaming-v69/master/improvement/nginx-debian12.conf > "${FOS_DIR}/nginx/conf/nginx.conf" 2>/dev/null || {
    log_warn "Could not download nginx-debian12.conf, using default..."
    curl -s https://raw.githubusercontent.com/theraw/FOS-Streaming-v69/master/improvement/nginx.conf > "${FOS_DIR}/nginx/conf/nginx.conf"
}

# Update nginx configuration with SSL and ports
log_info "Configuring nginx with ports - Web: ${WEB_PORT}, Stream: ${STREAM_PORT}, RTMP: ${RTMP_PORT}..."

# Update HTTPS ports in nginx config
sed -i "s/listen 8000;/listen ${STREAM_PORT} ssl http2;/g" "${FOS_DIR}/nginx/conf/nginx.conf"
sed -i "s/listen \[::\]:8000;/listen [::]:${STREAM_PORT} ssl http2;/g" "${FOS_DIR}/nginx/conf/nginx.conf"
sed -i "s/listen 7777;/listen ${WEB_PORT} ssl http2;/g" "${FOS_DIR}/nginx/conf/nginx.conf"
sed -i "s/listen \[::\]:7777;/listen [::]:${WEB_PORT} ssl http2;/g" "${FOS_DIR}/nginx/conf/nginx.conf"

# Update RTMP port in nginx config
sed -i "s/listen 1935;/listen ${RTMP_PORT};/g" "${FOS_DIR}/nginx/conf/nginx.conf"

# Update RTMP authentication callback URLs to use the correct web port
sed -i "s|http://127.0.0.1:7777/rtmp_|http://127.0.0.1:${WEB_PORT}/rtmp_|g" "${FOS_DIR}/nginx/conf/nginx.conf"

# Add SSL configuration to streaming server block (after "listen" directives)
sed -i "/listen \[::\]:${STREAM_PORT} ssl http2;/a\\
\\
        # SSL Configuration\\
        ssl_certificate ${CERTS_DIR}/fullchain.pem;\\
        ssl_certificate_key ${CERTS_DIR}/privkey.pem;\\
        ssl_protocols TLSv1.2 TLSv1.3;\\
        ssl_ciphers HIGH:!aNULL:!MD5;\\
        ssl_prefer_server_ciphers on;" "${FOS_DIR}/nginx/conf/nginx.conf"

# Add SSL configuration to web panel server block
sed -i "/listen \[::\]:${WEB_PORT} ssl http2;/a\\
\\
        # SSL Configuration\\
        ssl_certificate ${CERTS_DIR}/fullchain.pem;\\
        ssl_certificate_key ${CERTS_DIR}/privkey.pem;\\
        ssl_protocols TLSv1.2 TLSv1.3;\\
        ssl_ciphers HIGH:!aNULL:!MD5;\\
        ssl_prefer_server_ciphers on;" "${FOS_DIR}/nginx/conf/nginx.conf"

# Set ownership
chown -R fosstreaming:fosstreaming "${FOS_DIR}/nginx/conf"
chown -R fosstreaming:fosstreaming "${CERTS_DIR}"

log_info "Nginx configured with HTTPS support"

# ============================================================================
# STEP 13: Configure System Startup
# ============================================================================
log_step "Step 13: Configuring System Startup"

# Create systemd service for nginx
log_info "Creating systemd service for nginx..."
cat > /etc/systemd/system/fos-nginx.service <<EOF
[Unit]
Description=FOS-Streaming Nginx Server
After=network.target

[Service]
Type=forking
User=fosstreaming
Group=fosstreaming
PIDFile=${FOS_DIR}/nginx/pid/nginx.pid
ExecStartPre=${FOS_DIR}/nginx/sbin/nginx -t -c ${FOS_DIR}/nginx/conf/nginx.conf
ExecStart=${FOS_DIR}/nginx/sbin/nginx -c ${FOS_DIR}/nginx/conf/nginx.conf
ExecReload=/bin/kill -s HUP \$MAINPID
ExecStop=/bin/kill -s QUIT \$MAINPID
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

# Enable and start services
systemctl daemon-reload
systemctl enable fos-nginx
systemctl enable php${PHP_VERSION}-fpm

# Stop services if running
systemctl stop fos-nginx 2>/dev/null || true
systemctl stop php${PHP_VERSION}-fpm 2>/dev/null || true

# Start services
log_info "Starting services..."
systemctl start php${PHP_VERSION}-fpm
sleep 2
systemctl start fos-nginx

# ============================================================================
# STEP 14: Initialize Database
# ============================================================================
log_step "Step 14: Initializing Database"

log_info "Waiting for services to start..."
sleep 5

# Initialize database tables
log_info "Creating database tables..."
curl -s -k "https://127.0.0.1:${WEB_PORT}/install_database_tables.php?install=fresh" > /dev/null 2>&1 || true
sleep 2
curl -s -k "https://127.0.0.1:${WEB_PORT}/install_database_tables.php?install" > /dev/null 2>&1 || true
sleep 2
curl -s -k "https://127.0.0.1:${WEB_PORT}/install_database_tables.php?update" > /dev/null 2>&1 || true

# Remove installation file
rm -f "${FOS_DIR}/www/install_database_tables.php"

# ============================================================================
# STEP 15: Setup Cron Job
# ============================================================================
log_step "Step 15: Setting up Cron Job"

log_info "Adding cron job for stream monitoring..."
CRON_CMD="*/2 * * * * /usr/bin/php ${FOS_DIR}/www/cron.php"
(crontab -l 2>/dev/null | grep -v "cron.php"; echo "$CRON_CMD") | crontab -

# ============================================================================
# STEP 16: Security Hardening
# ============================================================================
log_step "Step 16: Applying Security Hardening"

# Configure firewall (if ufw is installed)
if command -v ufw &> /dev/null; then
    log_info "Configuring firewall..."
    ufw allow ${WEB_PORT}/tcp comment 'FOS Web Panel HTTPS'
    ufw allow ${STREAM_PORT}/tcp comment 'FOS Streaming HTTPS'
    ufw allow ${RTMP_PORT}/tcp comment 'FOS RTMP'
    log_info "Firewall rules added for ports: ${WEB_PORT}, ${STREAM_PORT}, ${RTMP_PORT}"
fi

# Set stricter file permissions
chmod 600 "${FOS_DIR}/www/config.php"
chmod 644 "${FOS_DIR}/www/config/ports.php"
chmod 600 /root/MYSQL_ROOT_PASSWORD

# Create Let's Encrypt upgrade script
log_info "Creating Let's Encrypt upgrade script..."
cat > /root/upgrade-to-letsencrypt.sh <<'UPGRADE_SCRIPT'
#!/bin/bash

# FOS-Streaming Let's Encrypt SSL Upgrade Script
# This script upgrades from self-signed to Let's Encrypt SSL certificates

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}FOS-Streaming Let's Encrypt SSL Upgrade${NC}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: This script must be run as root${NC}"
    exit 1
fi

# Get domain and email
read -p "Enter your domain name (e.g., stream.example.com): " DOMAIN
if [ -z "$DOMAIN" ]; then
    echo -e "${RED}Error: Domain name is required${NC}"
    exit 1
fi

read -p "Enter your email address for Let's Encrypt notifications: " EMAIL
if [ -z "$EMAIL" ]; then
    echo -e "${RED}Error: Email address is required${NC}"
    exit 1
fi

FOS_DIR="/home/fos-streaming/fos"
CERTS_DIR="${FOS_DIR}/nginx/conf/certs"

# Backup existing certificates
echo -e "${YELLOW}Backing up existing certificates...${NC}"
cp -a "${CERTS_DIR}" "${CERTS_DIR}.backup.$(date +%Y%m%d%H%M%S)"

# Install certbot
echo -e "${GREEN}Installing certbot...${NC}"
apt-get update -y
apt-get install -y certbot

# Stop nginx
echo -e "${YELLOW}Stopping nginx...${NC}"
systemctl stop fos-nginx

# Obtain certificate
echo -e "${GREEN}Obtaining Let's Encrypt certificate...${NC}"
certbot certonly --standalone --non-interactive --agree-tos \
    --email "$EMAIL" -d "$DOMAIN"

if [ $? -eq 0 ]; then
    # Link certificates
    echo -e "${GREEN}Linking certificates...${NC}"
    rm -f "${CERTS_DIR}/fullchain.pem" "${CERTS_DIR}/privkey.pem"
    ln -s "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" "${CERTS_DIR}/fullchain.pem"
    ln -s "/etc/letsencrypt/live/${DOMAIN}/privkey.pem" "${CERTS_DIR}/privkey.pem"

    # Set permissions
    chown -R fosstreaming:fosstreaming "${CERTS_DIR}"

    # Create renewal hook
    mkdir -p /etc/letsencrypt/renewal-hooks/deploy
    cat > /etc/letsencrypt/renewal-hooks/deploy/fos-nginx-reload.sh <<'EOF'
#!/bin/bash
systemctl reload fos-nginx
EOF
    chmod +x /etc/letsencrypt/renewal-hooks/deploy/fos-nginx-reload.sh

    # Start nginx
    echo -e "${GREEN}Starting nginx...${NC}"
    systemctl start fos-nginx

    echo ""
    echo -e "${GREEN}============================================${NC}"
    echo -e "${GREEN}Let's Encrypt SSL certificate installed!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo ""
    echo -e "Your site is now secured with Let's Encrypt SSL"
    echo -e "Access your panel at: https://${DOMAIN}:$(cat /home/fos-streaming/fos/www/config/ports.php | grep web_port | grep -oP '\d+')"
    echo ""
    echo -e "Certificates will auto-renew via certbot timer"
    echo ""
else
    echo -e "${RED}Failed to obtain Let's Encrypt certificate${NC}"
    echo -e "${YELLOW}Restoring backup and starting nginx...${NC}"
    systemctl start fos-nginx
    exit 1
fi
UPGRADE_SCRIPT

chmod +x /root/upgrade-to-letsencrypt.sh

log_info "Security hardening completed"

# ============================================================================
# INSTALLATION COMPLETE
# ============================================================================
log_step "Installation Complete!"

echo ""
echo "================================================================"
echo "  FOS-Streaming v69 Installation Successful!"
echo "================================================================"
echo ""
echo "  ðŸ”’ SECURE HTTPS INSTALLATION"
echo ""
echo "  Web Panel:    https://${PUBLIC_IP}:${WEB_PORT}"
echo "  Streaming:    https://${PUBLIC_IP}:${STREAM_PORT}"
echo "  RTMP:         rtmp://${PUBLIC_IP}:1935"
echo ""
echo "  Username:     admin"
echo "  Password:     admin"
echo ""
echo "  âš ï¸  IMPORTANT: Change the default password immediately!"
echo ""
echo "================================================================"
echo "  Security Features:"
echo "================================================================"
echo ""
echo "  âœ“ Random Cloudflare-compatible SSL ports selected"
echo "  âœ“ Self-signed SSL certificates installed"
echo "  âœ“ HTTPS enabled with TLS 1.2/1.3"
echo "  âœ“ HTTP/2 support enabled"
echo ""
echo "  Port Configuration:"
echo "    Web Port:    ${WEB_PORT} (Cloudflare SSL)"
echo "    Stream Port: ${STREAM_PORT} (Cloudflare SSL)"
echo "    RTMP Port:   ${RTMP_PORT} (Random)"
echo ""
echo "  Ports saved to: ${FOS_DIR}/www/config/ports.php"
echo ""
echo "================================================================"
echo "  SSL Certificate Management:"
echo "================================================================"
echo ""
echo "  Current: Self-signed certificate (for testing)"
echo ""
echo "  To upgrade to Let's Encrypt (production):"
echo "    1. Point your domain to this server IP: ${PUBLIC_IP}"
echo "    2. Run: bash /root/upgrade-to-letsencrypt.sh"
echo ""
echo "  Certificate location: ${CERTS_DIR}/"
echo ""
echo "================================================================"
echo "  Database Credentials:"
echo "================================================================"
echo ""
echo "  MySQL Root Password: saved in /root/MYSQL_ROOT_PASSWORD"
echo "  Database: fos"
echo "  DB User:  fos"
echo "  DB Pass:  (same as MySQL root)"
echo ""
echo "================================================================"
echo "  Post-Installation Steps:"
echo "================================================================"
echo ""
echo "  1. Login to web panel: https://${PUBLIC_IP}:${WEB_PORT}"
echo "     (Accept self-signed certificate warning in browser)"
echo ""
echo "  2. Go to Settings and update 'Web ip' to: ${PUBLIC_IP}"
echo ""
echo "  3. Change default admin password"
echo ""
echo "  4. Configure your first stream"
echo ""
echo "  5. (Optional) Setup Let's Encrypt SSL:"
echo "     bash /root/upgrade-to-letsencrypt.sh"
echo ""
echo "================================================================"
echo "  Service Management:"
echo "================================================================"
echo ""
echo "  systemctl status fos-nginx"
echo "  systemctl status php${PHP_VERSION}-fpm"
echo "  systemctl status mariadb"
echo ""
echo "  systemctl restart fos-nginx"
echo "  systemctl reload fos-nginx"
echo ""
echo "================================================================"
echo "  Important Files:"
echo "================================================================"
echo ""
echo "  Configuration:    ${FOS_DIR}/www/config.php"
echo "  Port Config:      ${FOS_DIR}/www/config/ports.php"
echo "  Nginx Config:     ${FOS_DIR}/nginx/conf/nginx.conf"
echo "  SSL Certs:        ${CERTS_DIR}/"
echo "  Logs:             ${FOS_DIR}/logs/"
echo ""
echo "  Cron Job:         */2 * * * * /usr/bin/php ${FOS_DIR}/www/cron.php"
echo ""
echo "================================================================"
echo "  Cloudflare Integration:"
echo "================================================================"
echo ""
echo "  Your ports are Cloudflare SSL-compatible!"
echo "  To use Cloudflare:"
echo "    1. Add your domain to Cloudflare"
echo "    2. Set SSL/TLS mode to 'Full' or 'Full (strict)'"
echo "    3. Create DNS A record pointing to: ${PUBLIC_IP}"
echo "    4. Upgrade to Let's Encrypt for 'Full (strict)' mode"
echo ""
echo "================================================================"
echo ""

log_info "Installation script finished successfully!"
log_info "Enjoy your secure FOS-Streaming installation!"
